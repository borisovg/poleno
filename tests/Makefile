LCOV_FILE  = coverage/coverage.lcov
SPEC_FILES = $(wildcard *.spec.js)
TEMP_DIR   = ./tests/.nyc_output
TEMP_FILES = $(wildcard .nyc_*) coverage node_modules npm-debug.log

all: test

## clean: delete NPM packages and files generated by nyc
.PHONY: clean
clean:
	rm -rf $(TEMP_FILES)

## test:  run tests
.PHONY: test
test: node_modules
	./node_modules/.bin/nyc \
		--all \
		--cwd ../ \
		--exclude tests/** \
		--reporter=html \
		--reporter=text \
		--cache-dir ./.nyc_cache \
		--temp-directory $(TEMP_DIR) \
		node_modules/.bin/mocha $(SPEC_FILES)

.PHONY: coverage
coverage:
	./node_modules/.bin/nyc report \
		--cwd ../ \
		--temp-directory $(TEMP_DIR) \
		--reporter=text-lcov \
		> $(LCOV_FILE)
	./node_modules/.bin/codecov \
		-f $(LCOV_FILE)

node_modules: package.json
	npm update || (rm -rf node_modules; exit 1)
	touch node_modules

.PHONY: help
help:
	@echo
	@sed -n 's/^##//p' Makefile
	@echo
